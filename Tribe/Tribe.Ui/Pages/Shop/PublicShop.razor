@page "/shop/{CreatorId}"
@using Tribe.Bib.ShopRelated
@using static Tribe.Bib.ShopRelated.ShopStruckture
@inject IProductClientService ProductClient
@inject ShopService ShopService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-6" Elevation="2">
        @if (_isLoading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (_products.Count == 0)
        {
            <MudAlert Severity="Severity.Info">Keine Produkte verfügbar</MudAlert>
        }
        else
        {
            <MudStack Spacing="3">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h5">Shop für Creator {CreatorId}</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchTerm" Placeholder="Suche..." />
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                              Href="/shop/cart">
                        Warenkorb ({ShopService.Cart.TotalItems})
                    </MudButton>
                </MudStack>

                <MudGrid>
                    @foreach (var product in _filteredProducts)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudCard>
                                <MudCardMedia Image="@(product.ThumbnailUrl ?? "https://via.placeholder.com/300")" Height="200" />
                                <MudCardContent>
                                    <MudText Typo="Typo.h6">@product.Title</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.TextSecondary">
                                        @product.ProductTypeDisplay
                                    </MudText>
                                    <MudText Typo="Typo.body2" Class="mt-2">
                                        @if (product.OriginalPrice.HasValue && product.OriginalPrice > product.Price)
                                        {
                                            <span style="text-decoration: line-through;">€@product.OriginalPrice.Value.ToString("F2")</span>
                                        }
                                        <strong>€@product.Price.ToString("F2")</strong>
                                    </MudText>
                                    <MudRating ReadOnly="true" Value="GetAverageRating(product.Id)" />
                                </MudCardContent>
                                <MudCardActions>
                                    <MudButton Size="Size.Small" OnClick="@(async () => await ViewProduct(product.Id))">
                                        Details
                                    </MudButton>
                                    <MudButton Size="Size.Small" Color="Color.Primary" 
                                              OnClick="@(async () => await AddToCart(product))">
                                        In den Warenkorb
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@code{
    [Parameter] public string? CreatorId { get; set; }
    private List<ShopProduct> _products = new();
    private List<ProductReview> _reviews = new();
    private string _searchTerm = "";
    private bool _isLoading = true;

    private List<ShopProduct> _filteredProducts => 
        string.IsNullOrWhiteSpace(_searchTerm) 
            ? _products 
            : ShopService.SearchProducts(_searchTerm);

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(CreatorId))
        {
            await LoadProducts();
        }
    }

    private async Task LoadProducts()
    {
        try
        {
            _isLoading = true;
            // Note: need API endpoint to get products by creator
            _products = await ProductClient.GetMyProductsAsync();
            _products = _products.Where(p => p.CreatorProfileId == CreatorId).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task AddToCart(ShopProduct product)
    {
        ShopService.AddToCart(product, 1);
        Snackbar.Add($"{product.Title} zum Warenkorb hinzugefügt", Severity.Success);
    }

    private async Task ViewProduct(string id)
    {
        Navigation.NavigateTo($"/shop/product/{id}");
    }

    private int GetAverageRating(string productId)
    {
        // TODO: Load reviews and calculate average
        return 4;
    }
}
