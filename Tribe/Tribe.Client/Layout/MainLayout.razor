@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Tribe.Client.Services
@using Tribe.Services.ClientServices.SimpleAuth
@inject ISignalRService SignalRService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable

<CascadingAuthenticationState>
    <Tribe.Ui.States.CascadingUserState>
        <Child>
            <MudThemeProvider />
            <MudPopoverProvider />
            <MudDialogProvider />
            <MudSnackbarProvider />
            <MudLayout>
                <MudAppBar Elevation="1">
                    <MudStaticNavDrawerToggle DrawerId="nav-drawer" Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" />
                    <MudText Typo="Typo.h5" Class="ml-3">Tribe Application</MudText>
                    <MudSpacer />

                    <!-- SignalR Connection Status -->
                    <MudTooltip Text="@(SignalRService.IsConnected ? "SignalR Connected" : "SignalR Disconnected")">
                        <MudIcon Icon="@Icons.Material.Filled.Circle"
                                 Color="@(SignalRService.IsConnected ? Color.Success : Color.Error)"
                                 Size="Size.Small"
                                 Class="mr-2" />
                    </MudTooltip>

                    <!-- Auth Status Display -->
                    <AuthorizeView>
                        <Authorized>
                            <MudTooltip Text="@($"Angemeldet als {context.User.Identity?.Name}")">
                                <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Success" Size="Size.Small" Class="mr-2" />
                            </MudTooltip>
                        </Authorized>
                        <NotAuthorized>
                            <MudTooltip Text="Nicht angemeldet">
                                <MudIcon Icon="@Icons.Material.Filled.LockOpen" Color="Color.Warning" Size="Size.Small" Class="mr-2" />
                            </MudTooltip>
                        </NotAuthorized>
                    </AuthorizeView>

                    <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End" />
                </MudAppBar>
                <MudDrawer id="nav-drawer" @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
                    <Nav2 />
                </MudDrawer>
                <MudMainContent Class="pt-16 pa-4">
                    @Body
                </MudMainContent>
            </MudLayout>
        </Child>
    </Tribe.Ui.States.CascadingUserState>
</CascadingAuthenticationState>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool _drawerOpen = true;

    protected override async Task OnInitializedAsync()
    {
        // SignalR Verbindung initialisieren
        try
        {
            await SignalRService.StartAsync();
            Console.WriteLine("[MainLayout] SignalR connected");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MainLayout] SignalR Error: {ex.Message}");
        }
    }

    public void Dispose()
    {
        // SignalR wird vom Service selbst verwaltet
    }
}