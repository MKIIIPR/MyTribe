@page "/creator/shop"
@using MudBlazor
@using Tribe.Services.ClientServices.ShopServices
@using Tribe.Bib.ShopRelated
@using static Tribe.Bib.ShopRelated.ShopStruckture
@inject IProductClientService ProductService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<Creator.CreatorLayout>
    <!-- Page Header -->
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-6">
        <MudStack Spacing="0">
            <MudBreadcrumbs Items="_breadcrumbs" Class="pa-0" />
            <MudText Typo="Typo.h4">Produkte</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Verwalte deine Shop-Produkte und Angebote.
            </MudText>
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.FilterList"
                       OnClick="@(() => _showFilters = !_showFilters)">
                Filter
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateProduct">
                Neues Produkt
            </MudButton>
        </MudStack>
    </MudStack>

    <!-- Filter Bar -->
    @if (_showFilters)
    {
        <MudPaper Elevation="0" Class="pa-4 rounded-lg mb-4" Style="border: 1px solid var(--mud-palette-lines-default);">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="_searchTerm" Label="Suche" Placeholder="Produktname..."
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true" Clearable="true" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudSelect T="string" @bind-Value="_statusFilter" Label="Status">
                        <MudSelectItem Value="@("")">Alle</MudSelectItem>
                        <MudSelectItem Value="@("Active")">Aktiv</MudSelectItem>
                        <MudSelectItem Value="@("Draft")">Entwurf</MudSelectItem>
                        <MudSelectItem Value="@("Inactive")">Inaktiv</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudSelect T="string" @bind-Value="_typeFilter" Label="Produkttyp">
                        <MudSelectItem Value="@("")">Alle</MudSelectItem>
                        <MudSelectItem Value="@("PhysicalProduct")">Physisch</MudSelectItem>
                        <MudSelectItem Value="@("DigitalProduct")">Digital</MudSelectItem>
                        <MudSelectItem Value="@("ImageProduct")">Bild</MudSelectItem>
                        <MudSelectItem Value="@("VideoProduct")">Video</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="2" Class="d-flex align-end">
                    <MudButton Variant="Variant.Text" OnClick="ClearFilters" FullWidth="true">
                        Filter zurücksetzen
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }

    <!-- Stats Summary -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="0" Class="pa-3 rounded-lg text-center" Style="border: 1px solid var(--mud-palette-lines-default);">
                <MudText Typo="Typo.h5" Color="Color.Primary">@_products.Count</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Gesamt</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="0" Class="pa-3 rounded-lg text-center" Style="border: 1px solid var(--mud-palette-lines-default);">
                <MudText Typo="Typo.h5" Color="Color.Success">@_products.Count(p => p.Status == "Active")</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Aktiv</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="0" Class="pa-3 rounded-lg text-center" Style="border: 1px solid var(--mud-palette-lines-default);">
                <MudText Typo="Typo.h5" Color="Color.Warning">@_products.Count(p => p.Status == "Draft")</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Entwürfe</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="0" Class="pa-3 rounded-lg text-center" Style="border: 1px solid var(--mud-palette-lines-default);">
                <MudText Typo="Typo.h5">€@_products.Sum(p => p.Price).ToString("N2")</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Gesamtwert</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Products Table -->
    <MudPaper Elevation="0" Class="rounded-lg" Style="border: 1px solid var(--mud-palette-lines-default);">
        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        
        <MudTable Items="@FilteredProducts" Hover="true" Striped="true" Dense="true"
                  Loading="_isLoading" LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh>Produkt</MudTh>
                <MudTh>Typ</MudTh>
                <MudTh Style="text-align: right;">Preis</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Erstellt</MudTh>
                <MudTh Style="text-align: center;">Aktionen</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Produkt">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        @if (!string.IsNullOrEmpty(context.ThumbnailUrl))
                        {
                            <MudAvatar Size="Size.Medium" Image="@context.ThumbnailUrl" Rounded="true" />
                        }
                        else
                        {
                            <MudAvatar Size="Size.Medium" Color="Color.Secondary" Rounded="true">
                                <MudIcon Icon="@Icons.Material.Filled.Image" />
                            </MudAvatar>
                        }
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@context.Title</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-truncate" Style="max-width: 200px;">
                                @context.Description
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Typ">
                    <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(context.ProductTypeDisplay)">
                        @context.ProductTypeDisplay
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Preis" Style="text-align: right;">
                    <MudStack Spacing="0" AlignItems="AlignItems.End">
                        @if (context.OriginalPrice.HasValue && context.OriginalPrice > context.Price)
                        {
                            <MudText Typo="Typo.caption" Style="text-decoration: line-through;" Color="Color.Secondary">
                                €@context.OriginalPrice.Value.ToString("F2")
                            </MudText>
                        }
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">€@context.Price.ToString("F2")</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Erstellt">
                    <MudText Typo="Typo.caption">@context.CreatedAt.ToString("dd.MM.yyyy")</MudText>
                </MudTd>
                <MudTd DataLabel="Aktionen" Style="text-align: center;">
                    <MudStack Row="true" Justify="Justify.Center" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                       OnClick="@(() => EditProduct(context))" Title="Bearbeiten" />
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                       OnClick="@(() => DuplicateProduct(context))" Title="Duplizieren" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                       OnClick="@(() => DeleteProduct(context))" Title="Löschen" />
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingBag" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">Keine Produkte gefunden</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Erstelle dein erstes Produkt, um loszulegen.
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                               OnClick="CreateProduct" Class="mt-2">
                        Produkt erstellen
                    </MudButton>
                </MudStack>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</Creator.CreatorLayout>

@code {
    [CascadingParameter(Name = "ProfileId")]
    private string? _profileId { get; set; }

    private List<ShopProduct> _products = new();
    private bool _isLoading = true;
    private bool _showFilters = false;
    private string _searchTerm = "";
    private string _statusFilter = "";
    private string _typeFilter = "";

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Dashboard", "/creator"),
        new BreadcrumbItem("Produkte", null, disabled: true)
    };

    private IEnumerable<ShopProduct> FilteredProducts =>
        _products.Where(p =>
            (string.IsNullOrEmpty(_searchTerm) || p.Title?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) == true) &&
            (string.IsNullOrEmpty(_statusFilter) || p.Status == _statusFilter) &&
            (string.IsNullOrEmpty(_typeFilter) || p.GetType().Name == _typeFilter)
        );

    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        _isLoading = true;
        try
        {
            if (!string.IsNullOrEmpty(_profileId))
            {
                _products = await ProductService.GetCreatorProductsAsync(_profileId) ?? new();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task CreateProduct()
    {
        // TODO: Öffne ProductEditDialog
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseButton = true };
        var dialog = await DialogService.ShowAsync<Tribe.Ui.Pages.UserDashboard.CreatorShop.ProductEditDialog>(
            "Neues Produkt", options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadProductsAsync();
        }
    }

    private async Task EditProduct(ShopProduct product)
    {
        var parameters = new DialogParameters { ["Product"] = product };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseButton = true };
        var dialog = await DialogService.ShowAsync<Tribe.Ui.Pages.UserDashboard.CreatorShop.ProductEditDialog>(
            "Produkt bearbeiten", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadProductsAsync();
        }
    }

    private async Task DuplicateProduct(ShopProduct product)
    {
        // Erstelle Kopie und öffne Dialog
        var copy = new ShopStruckture.PhysicalProduct // oder entsprechender Typ
        {
            Title = $"{product.Title} (Kopie)",
            Description = product.Description,
            Price = product.Price,
            ThumbnailUrl = product.ThumbnailUrl,
            Status = "Draft"
        };
        
        var parameters = new DialogParameters { ["Product"] = copy };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseButton = true };
        var dialog = await DialogService.ShowAsync<Tribe.Ui.Pages.UserDashboard.CreatorShop.ProductEditDialog>(
            "Produkt duplizieren", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadProductsAsync();
        }
    }

    private async Task DeleteProduct(ShopProduct product)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Produkt löschen",
            $"Möchtest du '{product.Title}' wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.",
            "Löschen", "Abbrechen");
        
        if (confirm == true)
        {
            try
            {
                await ProductService.DeleteProductAsync(product.Id);
                Snackbar.Add("Produkt gelöscht", Severity.Success);
                await LoadProductsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ClearFilters()
    {
        _searchTerm = "";
        _statusFilter = "";
        _typeFilter = "";
    }

    private Color GetStatusColor(string? status) => status switch
    {
        "Active" => Color.Success,
        "Draft" => Color.Default,
        "Inactive" => Color.Warning,
        _ => Color.Default
    };

    private Color GetTypeColor(string? type) => type switch
    {
        "Physisch" => Color.Info,
        "Digital" => Color.Secondary,
        "Bild" => Color.Warning,
        "Video" => Color.Error,
        _ => Color.Default
    };
}
