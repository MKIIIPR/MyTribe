@page "/shop/cart"
@using Tribe.Bib.ShopRelated
@using static Tribe.Bib.ShopRelated.ShopStruckture
@using MudBlazor
@using System.Net.Http.Json
@using Tribe.Services.ClientServices.ShopServices
@inject ShopService ShopService
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Class="pa-6" Elevation="2">
        <MudText Typo="Typo.h5">Warenkorb</MudText>

        @if (ShopService.Cart.Items.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">Ihr Warenkorb ist leer</MudAlert>
            <MudButton OnClick="@(() => Navigation.NavigateTo("/"))" Class="mt-4">
                Zum Shop
            </MudButton>
        }
        else
        {
            <MudTable Items="ShopService.Cart.Items" Class="mt-4">
                <HeaderContent>
                    <MudTh>Produkt</MudTh>
                    <MudTh>Preis</MudTh>
                    <MudTh>Menge</MudTh>
                    <MudTh>Gesamt</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate Context="context">
                    <MudTd>@context.ProductTitle</MudTd>
                    <MudTd>€@context.Price.ToString("F2")</MudTd>
                    <MudTd>
                        <MudNumericField T="int" @bind-Value="context.Quantity" Min="1" 
                                        OnChange="@((int val) => ShopService.UpdateCartQuantity(context.ProductId, val))" />
                    </MudTd>
                    <MudTd>€@context.TotalPrice.ToString("F2")</MudTd>
                    <MudTd>
                        <MudButton Size="Size.Small" Color="Color.Error" 
                                  OnClick="@(() => ShopService.RemoveFromCart(context.ProductId))">
                            Entfernen
                        </MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <MudStack Spacing="2" Class="mt-6">
                <MudText Typo="Typo.h6">
                    Gesamtbetrag: <strong>€@ShopService.Cart.TotalAmount.ToString("F2")</strong>
                </MudText>

                <MudTextField T="string" @bind-Value="_customerEmail" Label="E-Mail *" Required="true" />
                <MudTextField T="string" @bind-Value="_customerName" Label="Name *" Required="true" />
                <MudTextField T="string" @bind-Value="_customerPhone" Label="Telefon" />

                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Checkout">
                        Zur Kasse
                    </MudButton>
                    <MudButton Variant="Variant.Text" OnClick="@(() => Navigation.NavigateTo("/"))">
                        Weiter Einkaufen
                    </MudButton>
                </MudStack>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@code{
    private string _customerEmail = "";
    private string _customerName = "";
    private string _customerPhone = "";
    private bool _isProcessing = false;

    private async Task Checkout()
    {
        if (string.IsNullOrWhiteSpace(_customerEmail) || string.IsNullOrWhiteSpace(_customerName))
        {
            Snackbar.Add("Bitte E-Mail und Name eingeben", Severity.Warning);
            return;
        }

        if (ShopService.Cart.Items.Count == 0)
        {
            Snackbar.Add("Warenkorb ist leer", Severity.Warning);
            return;
        }

        try
        {
            _isProcessing = true;

            var order = new ShopOrder
            {
                CustomerEmail = _customerEmail,
                CustomerName = _customerName,
                CustomerPhone = _customerPhone,
                CustomerUserId = Guid.NewGuid().ToString(), // In production: get from auth
                TotalAmount = ShopService.Cart.TotalAmount,
                CreatorProfileId = "" // Set from product creator
            };

            var items = ShopService.Cart.Items.Select(ci => new ShopOrderItem
            {
                ProductId = ci.ProductId,
                ProductTitle = ci.ProductTitle,
                ProductType = ci.ProductType,
                Quantity = ci.Quantity,
                UnitPrice = ci.Price,
                TotalPrice = ci.TotalPrice
            }).ToList();

            var request = new { order, items };
            var response = await Http.PostAsJsonAsync("api/shop/orders/checkout", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<dynamic>();
                Snackbar.Add("Bestellung erstellt - bitte zum Zahlen weitergeleitet", Severity.Success);
                ShopService.ClearCart();
                
                // In production: redirect to payment provider
                // Navigation.NavigateTo(result.paymentUrl);
                Navigation.NavigateTo("/");
            }
            else
            {
                Snackbar.Add("Fehler beim Erstellen der Bestellung", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }
}
