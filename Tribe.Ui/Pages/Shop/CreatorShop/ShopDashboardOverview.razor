@page "/shop/dashboard"
@using MudBlazor
@using Tribe.Bib.ShopRelated
@using Tribe.Services.ClientServices.ShopServices
@using static Tribe.Bib.ShopRelated.ShopStruckture
@inject IShopCreatorService ShopService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Spacing="4">
        <!-- Header -->
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Dashboard" Size="Size.Large" Color="Color.Primary" />
            <MudText Typo="Typo.h4">Shop Dashboard</MudText>
            <MudSpacer />
            <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Href="/shop/products/create">
                Neues Produkt
            </MudButton>
        </MudStack>

        @if (_isLoading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <!-- Orders Overview -->
            <MudGrid>
                <!-- Open Orders -->
                <MudItem xs="12" md="6">
                    <MudCard Elevation="3">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Offene Bestellungen</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@_openOrders.Count Bestellungen</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" OnClick="LoadOrders" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (_openOrders.Count == 0)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Keine offenen Bestellungen</MudText>
                            }
                            else
                            {
                                <MudStack Spacing="1">
                                    @foreach (var order in _openOrders.Take(5))
                                    {
                                        <MudPaper Elevation="1" Class="pa-2">
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2" Style="font-weight: bold;">@order.OrderNumber</MudText>
                                                <MudText Typo="Typo.caption">@order.CreatedAt.ToString("dd.MM.yyyy HH:mm") - €@order.TotalAmount.ToString("F2")</MudText>
                                            </MudStack>
                                        </MudPaper>
                                    }
                                    @if (_openOrders.Count > 5)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">... und @_openOrders.Count weitere</MudText>
                                    }
                                </MudStack>
                            }
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" OnClick="@(() => Navigation.NavigateTo("/shop/orders"))">Alle anzeigen</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>

                <!-- Shipped Orders -->
                <MudItem xs="12" md="6">
                    <MudCard Elevation="3">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Verschickte Bestellungen</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@_shippedOrders.Count Bestellungen</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" OnClick="LoadOrders" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (_shippedOrders.Count == 0)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Keine verschickten Bestellungen</MudText>
                            }
                            else
                            {
                                <MudStack Spacing="1">
                                    @foreach (var order in _shippedOrders.Take(5))
                                    {
                                        <MudPaper Elevation="1" Class="pa-2">
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2" Style="font-weight: bold;">@order.OrderNumber</MudText>
                                                <MudText Typo="Typo.caption">@order.UpdatedAt.ToString("dd.MM.yyyy HH:mm") - €@order.TotalAmount.ToString("F2")</MudText>
                                            </MudStack>
                                        </MudPaper>
                                    }
                                    @if (_shippedOrders.Count > 5)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">... und @_shippedOrders.Count weitere</MudText>
                                    }
                                </MudStack>
                            }
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" OnClick="@(() => Navigation.NavigateTo("/shop/orders"))">Alle anzeigen</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            </MudGrid>

            <!-- Quick Stats -->
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="2">
                        <MudCardContent Class="text-center">
                            <MudText Typo="Typo.h4" Color="Color.Primary">@_totalOrders</MudText>
                            <MudText Typo="Typo.body2">Gesamt Bestellungen</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="2">
                        <MudCardContent Class="text-center">
                            <MudText Typo="Typo.h4" Color="Color.Warning">@_openOrders.Count</MudText>
                            <MudText Typo="Typo.body2">Offen</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="2">
                        <MudCardContent Class="text-center">
                            <MudText Typo="Typo.h4" Color="Color.Success">@_shippedOrders.Count</MudText>
                            <MudText Typo="Typo.body2">Verschickt</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="2">
                        <MudCardContent Class="text-center">
                            <MudText Typo="Typo.h4" Color="Color.Info">€@_totalRevenue.ToString("F2")</MudText>
                            <MudText Typo="Typo.body2">Umsatz</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        }
    </MudStack>
</MudContainer>

@code {
    private List<ShopOrder> _orders = new();
    private List<ShopOrder> _openOrders = new();
    private List<ShopOrder> _shippedOrders = new();
    private int _totalOrders = 0;
    private decimal _totalRevenue = 0;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            _orders = await ShopService.GetCreatorOrdersAsync() ?? new();

            // Filter orders
            _openOrders = _orders.Where(o => o.Status == OrderStatus.Pending || o.Status == OrderStatus.Processing).ToList();
            _shippedOrders = _orders.Where(o => o.Status == OrderStatus.Shipped).ToList();

            // Calculate stats
            _totalOrders = _orders.Count;
            _totalRevenue = _orders.Where(o => o.Status == OrderStatus.Shipped).Sum(o => o.TotalAmount);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden der Bestellungen: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}