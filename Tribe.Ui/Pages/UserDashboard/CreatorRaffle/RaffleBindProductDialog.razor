@namespace Tribe.Ui.Pages.UserDashboard.CreatorRaffle
@using MudBlazor
@using Tribe.Bib.ShopRelated
@using static Tribe.Bib.ShopRelated.ShopStruckture
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">Raffle an Produkt binden</MudText>
            
            <MudAlert Severity="Severity.Info" ShowCloseIcon="false">
                Wählen Sie ein Produkt aus, um diese Raffle daran zu binden. Beim Kauf erhalten Kunden automatisch ein Los für die Raffle.
            </MudAlert>

            @if (_isLoading)
            {
                <MudProgressCircular Indeterminate="true" />
            }
            else if (_products.Count == 0)
            {
                <MudAlert Severity="Severity.Warning">
                    Keine Produkte verfügbar. Erstellen Sie zuerst ein Produkt im Shop.
                </MudAlert>
            }
            else
            {
                <MudSelect T="string"
                    @bind-Value="_selectedProductId" 
                    Label="Produkt wählen *" 
                    Required="true"
                    Variant="Variant.Outlined"
                    HelperText="Wählen Sie das Produkt, an das die Raffle gebunden werden soll">
                    @foreach (var product in _products)
                    {
                        <MudSelectItem Value="@product.Id">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudText>@product.Title</MudText>
                                <MudChip T="decimal" Size="Size.Small" Color="Color.Secondary">€@product.Price.ToString("F2")</MudChip>
                            </MudStack>
                        </MudSelectItem>
                    }
                </MudSelect>

                <!-- Tokens pro Kauf -->
                <MudNumericField 
                    @bind-Value="_tokensPerPurchase" 
                    Label="Tickets/Lose pro Kauf"
                    Variant="Variant.Outlined"
                    Min="1"
                    Max="10"
                    HelperText="Wie viele Tickets erhält der Kunde pro Kauf?" />

                <MudAlert Severity="Severity.Success">
                    <MudText Typo="Typo.body2">
                        Bei jedem Kauf dieses Produkts für €<strong>@(_selectedProduct?.Price.ToString("F2") ?? "0,00")</strong> 
                        erhält der Kunde <strong>@_tokensPerPurchase Ticket(s)</strong> für die Raffle.
                    </MudText>
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Abbrechen</MudButton>
        <MudButton 
            Color="Color.Primary" 
            Variant="Variant.Filled" 
            OnClick="Save" 
            Disabled="string.IsNullOrEmpty(_selectedProductId) || _isLoading">
            Binden
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter] 
    public string RaffleId { get; set; } = string.Empty;

    private List<ShopProduct> _products = new();
    private ShopProduct? _selectedProduct;
    private string _selectedProductId = string.Empty;
    private int _tokensPerPurchase = 1;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            _isLoading = true;
            var response = await Http.GetAsync("api/products");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var options = new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase };
                _products = System.Text.Json.JsonSerializer.Deserialize<List<ShopProduct>>(json, options) ?? new();
            }
            else
            {
                Snackbar.Add("Fehler beim Laden der Produkte", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task Save()
    {
        if (string.IsNullOrEmpty(_selectedProductId))
        {
            Snackbar.Add("Bitte wählen Sie ein Produkt", Severity.Warning);
            return;
        }

        try
        {
            var response = await Http.PostAsync(
                $"api/shop/raffles/bind/{RaffleId}/product/{_selectedProductId}",
                null);

            if (response.IsSuccessStatusCode)
            {
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Fehler beim Binden: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task OnProductSelected()
    {
        _selectedProduct = _products.FirstOrDefault(p => p.Id == _selectedProductId);
        await Task.CompletedTask;
    }
}
