@using MudBlazor
@using Tribe.Bib.Models.TribeRelated
@using Tribe.Bib.ShopRelated
@using static Tribe.Bib.ShopRelated.ShopStruckture
@inject Tribe.Services.ClientServices.ShopServices.IProductClientService ProductClient
@inject Tribe.Services.ClientServices.ShopServices.IRaffleClientService RaffleService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4 mt-4">
    <MudStack Spacing="3">
        <MudStack Row="true" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">Produkte</MudText>
            <MudSpacer />
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateNew">Neues Produkt</MudButton>
        </MudStack>

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else if (_products.Count == 0)
        {
            <MudText>Keine Produkte vorhanden.</MudText>
        }
        else
        {
            <MudTable Items="_products" Hover="true">
                <HeaderContent>
                    <MudTh>Titel</MudTh>
                    <MudTh>Preis</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Raffle</MudTh>
                    <MudTh>Aktionen</MudTh>
                </HeaderContent>
                <RowTemplate Context="p">
                    <MudTd>@p.Title</MudTd>
                    <MudTd>€@p.Price.ToString("F2")</MudTd>
                    <MudTd>@p.Status</MudTd>
                    <MudTd>
                        @if (_productRaffles.TryGetValue(p.Id, out var raffle) && raffle != null)
                        {
                            <MudChip T="string" Color="Color.Info" Variant="Variant.Filled" Size="Size.Small" Text="@raffle.Title" />
                        }
                        else
                        {
                            <MudText Typo="Typo.caption">Keine</MudText>
                        }
                    </MudTd>
                    <MudTd>
                        <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="@(async () => await Edit(p.Id))">Bearbeiten</MudButton>
                        <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Error" OnClick="@(async () => await Delete(p.Id))">Löschen</MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudStack>
</MudPaper>

@code {
    private List<ShopProduct> _products = new();
    private Dictionary<string, Raffle?> _productRaffles = new();
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            _isLoading = true;
            _products = await ProductClient.GetMyProductsAsync() ?? new List<ShopProduct>();
            await LoadProductRaffles();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadProductRaffles()
    {
        var tasks = _products.Select(async product =>
        {
            try
            {
                return (product.Id, await RaffleService.GetProductRaffleAsync(product.Id));
            }
            catch
            {
                return (product.Id, (Raffle?)null);
            }
        });

        var results = await Task.WhenAll(tasks);
        _productRaffles = results.ToDictionary(r => r.Item1, r => r.Item2);
    }

        private async Task CreateNew()
        {
            var parameters = new DialogParameters<ProductEditDialog>
            {
                { x => x.Product, new PhysicalProduct() }
            };
            var dialog = DialogService.Show<ProductEditDialog>("Neues Produkt", parameters);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                await LoadProducts();
            }
        }

        private async Task Edit(string id)
        {
            var product = await ProductClient.GetProductByIdAsync(id);
            if (product == null)
            {
                Snackbar.Add("Produkt nicht gefunden", Severity.Warning);
                return;
            }

            var parameters = new DialogParameters<ProductEditDialog>
            {
                { x => x.Product, product }
            };
            var dialog = DialogService.Show<ProductEditDialog>("Produkt bearbeiten", parameters);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                await LoadProducts();
            }
        }

    private async Task Delete(string id)
    {
        var confirmed = await DialogService.ShowMessageBox("Bestätigung", "Produkt wirklich löschen?", yesText: "Ja", cancelText: "Nein");
        if (confirmed != true) return;
        var ok = await ProductClient.DeleteProductAsync(id);
        if (ok) { await LoadProducts(); Snackbar.Add("Gelöscht", Severity.Success); }
        else Snackbar.Add("Fehler beim Löschen", Severity.Error);
    }
}
