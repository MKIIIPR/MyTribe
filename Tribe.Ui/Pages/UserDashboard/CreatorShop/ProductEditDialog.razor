@using MudBlazor
@using Tribe.Bib.Models.TribeRelated
@using Tribe.Services.ClientServices.ShopServices
@using static Tribe.Bib.ShopRelated.ShopStruckture

@inject IProductClientService ProductClient
@inject IRaffleClientService RaffleService
@inject ISnackbar Snackbar

<MudDialog MaxWidth="MaxWidth.Large" FullWidth="true" DisableBackdropClick="true" CloseOnEscapeKey="false">
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                <!-- Tab 1: Basis-Informationen -->
                <MudTabPanel Text="Basis" Icon="@Icons.Material.Filled.Info">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudText Typo="Typo.h5" Class="mb-3">@(string.IsNullOrEmpty(_editProduct?.Id) ? "Neues Produkt erstellen" : "Produkt bearbeiten")</MudText>
                        </MudItem>

                        <!-- Produkttyp Auswahl (nur bei neuem Produkt) -->
                        @if (IsNew)
                        {
                            <MudItem xs="12">
                                <MudSelect T="string" Value="_selectedProductType" ValueChanged="OnProductTypeChanged" Label="Produkttyp *" Required="true" Variant="Variant.Outlined">
                                    <MudSelectItem Value="@ProductTypes.Physical">Physisches Produkt</MudSelectItem>
                                    <MudSelectItem Value="@ProductTypes.Video">Video / Digital</MudSelectItem>
                                    <MudSelectItem Value="@ProductTypes.Image">Bilder / Fotos</MudSelectItem>
                                    <MudSelectItem Value="@ProductTypes.Service">Dienstleistung</MudSelectItem>
                                    <MudSelectItem Value="@ProductTypes.EventTicket">Event-Ticket</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                        }
                        else
                        {
                            <MudItem xs="12">
                                <MudTextField Value="@GetProductTypeLabel(_selectedProductType)" Label="Produkttyp" ReadOnly="true" Variant="Variant.Outlined" />
                            </MudItem>
                        }

                        <MudItem xs="12" md="8">
                            <MudTextField @bind-Value="_editProduct.Title" Label="Titel *" Required="true" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField T="decimal" @bind-Value="_editProduct.Price" Label="Preis (€) *" Min="0" Required="true" Variant="Variant.Outlined" Format="F2" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_editProduct.Description" Label="Beschreibung" Lines="4" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudSelect T="string" @bind-Value="_editProduct.Status" Label="Status" Variant="Variant.Outlined">
                                @foreach (var status in _statusOptions)
                                {
                                    <MudSelectItem Value="@status">@_statusLabels[status]</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField T="decimal?" @bind-Value="_originalPrice" Label="Original-Preis (€)" Variant="Variant.Outlined" Format="F2" HelperText="Für durchgestrichenen Preis" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Tab 2: Bilder -->
                <MudTabPanel Text="Bilder" Icon="@Icons.Material.Filled.Image">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudText Typo="Typo.h6" Class="mb-3">Produktbilder</MudText>
                        </MudItem>

                        <!-- Thumbnail -->
                        <MudItem xs="12" md="6">
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Hauptbild / Thumbnail</MudText>
                                @if (!string.IsNullOrEmpty(_editProduct.ThumbnailUrl))
                                {
                                    <MudImage Src="@_editProduct.ThumbnailUrl" Width="200" Height="200" ObjectFit="ObjectFit.Cover" Class="rounded mb-2" />
                                    <MudButton Color="Color.Error" Variant="Variant.Text" Size="Size.Small" OnClick="@(() => _editProduct.ThumbnailUrl = null)">
                                        Entfernen
                                    </MudButton>
                                }
                                else
                                {
                                    <MudPaper Elevation="0" Class="pa-4 d-flex align-center justify-center" Style="height: 200px; background: #f5f5f5; border: 2px dashed #ccc;">
                                        <MudText Color="Color.Secondary">Kein Bild</MudText>
                                    </MudPaper>
                                }
                                <div class="mt-2">
                                    <Tribe.Ui.Components.FileUploader OnImageUploaded="HandleThumbnailUpload" />
                                </div>
                            </MudPaper>
                        </MudItem>

                        <!-- Weitere Bilder -->
                        <MudItem xs="12" md="6">
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Weitere Bilder (@(_editProduct.ImageUrls?.Count ?? 0))</MudText>
                                <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="2">
                                    @if (_editProduct.ImageUrls != null)
                                    {
                                        @foreach (var (url, index) in _editProduct.ImageUrls.Select((u, i) => (u, i)))
                                        {
                                            <MudPaper Elevation="1" Class="pa-1 position-relative">
                                                <MudImage Src="@url" Width="80" Height="80" ObjectFit="ObjectFit.Cover" Class="rounded" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" Color="Color.Error" 
                                                              Style="position: absolute; top: -8px; right: -8px; background: white;"
                                                              OnClick="@(() => RemoveImage(index))" />
                                            </MudPaper>
                                        }
                                    }
                                </MudStack>
                                <div class="mt-2">
                                    <Tribe.Ui.Components.FileUploader OnImageUploaded="HandleAdditionalImageUpload" MultipleUpload="true" />
                                </div>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Tab 3: Typ-spezifische Details -->
                <MudTabPanel Text="Details" Icon="@Icons.Material.Filled.Settings">
                    @switch (_selectedProductType)
                    {
                        case ProductTypes.Physical:
                            <PhysicalProductFields Product="@((PhysicalProduct)_editProduct)" />
                            break;
                        case ProductTypes.Video:
                            <VideoProductFields Product="@((VideoProduct)_editProduct)" />
                            break;
                        case ProductTypes.Image:
                            <ImageProductFields Product="@((ImageProduct)_editProduct)" />
                            break;
                        case ProductTypes.Service:
                            <ServiceProductFields Product="@((ServiceProduct)_editProduct)" />
                            break;
                        case ProductTypes.EventTicket:
                            <EventTicketProductFields Product="@((EventTicketProduct)_editProduct)" />
                            break;
                    }
                </MudTabPanel>

                <!-- Tab 4: Raffle -->
                <MudTabPanel Text="Raffle" Icon="@Icons.Material.Filled.EmojiEvents">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Raffle an Produkt binden</MudText>
                            <MudSelect T="string" @bind-Value="_selectedRaffleId" Label="Raffle wählen" Variant="Variant.Outlined">
                                <MudSelectItem Value="@string.Empty">(keine)</MudSelectItem>
                                @foreach (var raffle in _raffles)
                                {
                                    <MudSelectItem Value="@raffle.Id">@raffle.Title</MudSelectItem>
                                }
                            </MudSelect>
                            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" Class="mt-2"
                                      Disabled="string.IsNullOrEmpty(_selectedRaffleId) || string.IsNullOrEmpty(_editProduct?.Id)" 
                                      OnClick="BindRaffle">
                                Raffle binden
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudText Typo="Typo.subtitle2">Aktuell gebundene Raffle</MudText>
                                @if (_boundRaffle != null)
                                {
                                    <MudText Typo="Typo.h6">@_boundRaffle.Title</MudText>
                                    <MudText Typo="Typo.body2">@(_boundRaffle.PrizeName ?? "Kein Preis")</MudText>
                                    <MudText Typo="Typo.caption">Status: @_boundRaffle.Status</MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Keine Raffle verknüpft</MudText>
                                }
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Abbrechen</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" Disabled="!_isValid" OnClick="SaveAsync">
            @(string.IsNullOrEmpty(_editProduct?.Id) || _isNewProduct ? "Erstellen" : "Speichern")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance Dialog { get; set; } = default!;

    [Parameter]
    public ShopProduct? Product { get; set; }

    // New-product decision is based on product id and server existence. No external IsNewProduct parameter required.

    private MudForm? _form;
    private bool _isValid;
    private ShopProduct _editProduct = new PhysicalProduct();
    private List<Raffle> _raffles = new();
    private string? _selectedRaffleId;
    private Raffle? _boundRaffle;
    private string _selectedProductType = ProductTypes.Physical;
    private decimal? _originalPrice;
    private bool _isNewProduct => Product == null || string.IsNullOrEmpty(Product?.Id);
    private bool _existsOnServer = false;

    // consider product new when it does not exist on server
    private bool IsNew => !_existsOnServer;

    private readonly string[] _statusOptions = { ProductStatus.Active, ProductStatus.Draft, ProductStatus.Inactive };
    private readonly Dictionary<string, string> _statusLabels = new()
    {
        { ProductStatus.Active, "Aktiv" },
        { ProductStatus.Draft, "Entwurf" },
        { ProductStatus.Inactive, "Inaktiv" }
    };

    protected override async Task OnParametersSetAsync()
    {
        // Wenn ein Produkt über Parameter geliefert wird: prüfe ob es bereits auf dem Server existiert
        _existsOnServer = false;
        if (Product != null && !string.IsNullOrEmpty(Product.Id))
        {
            try
            {
                var serverProduct = await ProductClient.GetProductByIdAsync(Product.Id);
                if (serverProduct != null)
                {
                    // Produkt existiert auf dem Server -> Edit-Modus mit aktuellen Daten
                    _existsOnServer = true;
                    _editProduct = CloneProduct(serverProduct);
                    _selectedProductType = GetProductType(_editProduct);
                }
                else
                {
                    // Produkt nicht auf Server -> treat as new
                    _editProduct = CreateProductByType(_selectedProductType);
                }
            }
            catch
            {
                // Bei Fehlern in der Abfrage: fallback auf neues Produkt (sicherer)
                _existsOnServer = false;
                _editProduct = CreateProductByType(_selectedProductType);
            }
        }
        else
        {
            // Kein Parameter geliefert -> neues Produkt erstellen
            _editProduct = CreateProductByType(_selectedProductType);
        }

        _originalPrice = _editProduct.OriginalPrice;
        _selectedRaffleId = null;
        await LoadRaffles();
        await RefreshBoundRaffleAsync();
    }

    private string GetProductType(ShopProduct product) => product switch
    {
        PhysicalProduct => ProductTypes.Physical,
        VideoProduct => ProductTypes.Video,
        ImageProduct => ProductTypes.Image,
        ServiceProduct => ProductTypes.Service,
        EventTicketProduct => ProductTypes.EventTicket,
        _ => ProductTypes.Physical
    };

    private string GetProductTypeLabel(string productType) => productType switch
    {
        ProductTypes.Physical => "Physisches Produkt",
        ProductTypes.Video => "Video / Digital",
        ProductTypes.Image => "Bilder / Fotos",
        ProductTypes.Service => "Dienstleistung",
        ProductTypes.EventTicket => "Event-Ticket",
        _ => "Unbekannt"
    };

    private ShopProduct CreateProductByType(string productType) => productType switch
    {
        ProductTypes.Physical => new PhysicalProduct(),
        ProductTypes.Video => new VideoProduct(),
        ProductTypes.Image => new ImageProduct(),
        ProductTypes.Service => new ServiceProduct(),
        ProductTypes.EventTicket => new EventTicketProduct(),
        _ => new PhysicalProduct()
    };

    private void OnProductTypeChanged(string newType)
    {
        if (_selectedProductType == newType) return;

        // Basisdaten sichern
        var title = _editProduct.Title;
        var description = _editProduct.Description;
        var price = _editProduct.Price;
        var status = _editProduct.Status;
        var thumbnailUrl = _editProduct.ThumbnailUrl;
        var imageUrls = _editProduct.ImageUrls?.ToList() ?? new List<string>();
        var tags = _editProduct.Tags?.ToList() ?? new List<string>();
        var categoryId = _editProduct.CategoryId;
        var seoTitle = _editProduct.SeoTitle;
        var seoDescription = _editProduct.SeoDescription;

        // Neues Produkt mit richtigem Typ erstellen
        _selectedProductType = newType;
        _editProduct = CreateProductByType(newType);

        // Basisdaten wiederherstellen
        _editProduct.Title = title;
        _editProduct.Description = description;
        _editProduct.Price = price;
        _editProduct.Status = status;
        _editProduct.ThumbnailUrl = thumbnailUrl;
        _editProduct.ImageUrls = imageUrls;
        _editProduct.Tags = tags;
        _editProduct.CategoryId = categoryId;
        _editProduct.SeoTitle = seoTitle;
        _editProduct.SeoDescription = seoDescription;

        StateHasChanged();
    }

    private void HandleThumbnailUpload(string base64Image)
    {
        _editProduct.ThumbnailUrl = base64Image;
        StateHasChanged();
    }

    private void HandleAdditionalImageUpload(string base64Image)
    {
        _editProduct.ImageUrls ??= new List<string>();
        _editProduct.ImageUrls.Add(base64Image);
        StateHasChanged();
    }

    private void RemoveImage(int index)
    {
        if (_editProduct.ImageUrls != null && index >= 0 && index < _editProduct.ImageUrls.Count)
        {
            _editProduct.ImageUrls.RemoveAt(index);
            StateHasChanged();
        }
    }

    private ShopProduct CloneProduct(ShopProduct source)
    {
        return source switch
        {
            PhysicalProduct physical => CloneViaJson(physical),
            VideoProduct video => CloneViaJson(video),
            ImageProduct image => CloneViaJson(image),
            ServiceProduct service => CloneViaJson(service),
            EventTicketProduct ticket => CloneViaJson(ticket),
            _ => new PhysicalProduct
            {
                Title = source.Title,
                Description = source.Description,
                Price = source.Price,
                CreatorProfileId = source.CreatorProfileId,
                Status = source.Status,
                CategoryId = source.CategoryId,
                Tags = source.Tags?.ToList() ?? new List<string>(),
            }
        };
    }

    private static T CloneViaJson<T>(T source) where T : ShopProduct
    {
        var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        var json = System.Text.Json.JsonSerializer.Serialize(source, options);
        var clone = System.Text.Json.JsonSerializer.Deserialize<T>(json, options);
        return clone ?? source;
    }

    private async Task LoadRaffles()
    {
        var data = await RaffleService.GetCreatorRafflesAsync();
        if (data != null)
        {
            _raffles = data;
        }
    }

    private async Task RefreshBoundRaffleAsync()
    {
        if (string.IsNullOrEmpty(_editProduct?.Id))
        {
            _boundRaffle = null;
            return;
        }

        _boundRaffle = await RaffleService.GetProductRaffleAsync(_editProduct.Id);
    }

    private async Task SaveAsync()
    {
        _form?.Validate();
        if (!_isValid)
        {
            return;
        }

        _editProduct.OriginalPrice = _originalPrice;

        try
        {
        if (IsNew)
            {
                // Neues Produkt erstellen
                var dto = BuildProductDto();
                var created = await ProductClient.CreateProductAsync(dto);
                if (created != null)
                {
                    // Produkt vom Server übernehmen und Formular updaten (nicht Dialog schließen)
                    _existsOnServer = true;
                    _editProduct = CloneProduct(created);
                    _selectedProductType = GetProductType(_editProduct);
                    _originalPrice = _editProduct.OriginalPrice;
                    Snackbar.Add("Produkt erstellt. Formular wurde mit serverseitigen Daten aktualisiert.", Severity.Success);
                    // Jetzt ist das Produkt existent — der Button wechselt zu "Speichern" und weitere Aktionen (z.B. Raffle binden) sind möglich.
                }
                else
                {
                    Snackbar.Add("Fehler beim Erstellen", Severity.Error);
                }
            }
            else
            {
                // Bestehendes Produkt aktualisieren
                var dto = BuildProductDto();
                var success = await ProductClient.UpdateProductAsync(_editProduct.Id, dto);
                if (success)
                {
                    Snackbar.Add("Produkt gespeichert", Severity.Success);
                    Dialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Fehler beim Speichern", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
    }

    private async Task BindRaffle()
    {
        if (string.IsNullOrEmpty(_selectedRaffleId) || string.IsNullOrEmpty(_editProduct?.Id))
        {
            return;
        }

        var bound = await RaffleService.BindRaffleToProductAsync(_selectedRaffleId, _editProduct.Id);
        if (bound)
        {
            Snackbar.Add("Raffle erfolgreich gebunden", Severity.Success);
            await RefreshBoundRaffleAsync();
        }
        else
        {
            Snackbar.Add("Fehler beim Binden", Severity.Error);
        }
    }

    private void Cancel() => Dialog.Cancel();

    private ProductDto BuildProductDto()
    {
        var dto = new ProductDto
        {
            Id = _editProduct.Id,
            Title = _editProduct.Title,
            Description = _editProduct.Description,
            Price = _editProduct.Price,
            OriginalPrice = (_editProduct as PhysicalProduct)?.OriginalPrice,
            Status = _editProduct.Status,
            CategoryId = _editProduct.CategoryId,
            ThumbnailUrl = _editProduct.ThumbnailUrl,
            ImageUrls = _editProduct.ImageUrls?.ToList() ?? new List<string>(),
            Tags = _editProduct.Tags?.ToList() ?? new List<string>(),
            SeoTitle = _editProduct.SeoTitle,
            SeoDescription = _editProduct.SeoDescription
        };

        switch (_editProduct)
        {
            case PhysicalProduct physical:
                dto.ProductType = ProductTypes.Physical;
                dto.SKU = physical.SKU;
                dto.StockQuantity = physical.StockQuantity;
                dto.TrackInventory = physical.TrackInventory;
                dto.ShippingCost = physical.ShippingCost;
                dto.FreeShippingOver = physical.FreeShippingOver;
                dto.FreeShippingThreshold = physical.FreeShippingThreshold;
                break;
            case VideoProduct video:
                dto.ProductType = ProductTypes.Video;
                dto.VideoUrl = video.VideoUrl;
                break;
            case ImageProduct image:
                dto.ProductType = ProductTypes.Image;
                dto.HighResImageUrls = image.HighResImageUrls?.ToList();
                dto.ImageFormat = image.ImageFormat;
                break;
            case ServiceProduct service:
                dto.ProductType = ProductTypes.Service;
                dto.DurationMinutes = service.DurationMinutes;
                break;
            case EventTicketProduct ticket:
                dto.ProductType = ProductTypes.EventTicket;
                dto.EventDate = ticket.EventDate;
                dto.EventEndDate = ticket.EventEndDate;
                dto.EventLocation = ticket.EventLocation;
                dto.MaxTickets = ticket.MaxTickets;
                break;
        }

        return dto;
    }
}
