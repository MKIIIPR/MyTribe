@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Logging
@using MudBlazor
@using System.Text.Json
@using System.Text
@using Tribe.Client.Services
@using Tribe.Bib.Models.TribeRelated
@using static Tribe.Bib.CommunicationModels.ComModels
@inject ILogger<CreatorPlanSelectionDialog> _logger
@inject HttpClient _client
@inject IDialogService DialogService
@inject IUserApiService _user
@inject ISnackbar Snackbar

<MudDialog Style="max-width: 900px;">
    <DialogContent>
        <MudContainer Class="mt-4">
            @if (IsLoading)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }
            else if (!_isFreeTrial)
            {
                <MudStepper @ref="stepper" Class="mb-6" @bind-ActiveIndex="CurrentStep">
                    <MudStep Title="Choose Plan">
                        <PlanSelectionStep CreatorPlans="@CreatorPlans"
                                           SelectedSubscription="@CreatorApplication"
                                           SelectedSubscriptionChanged="@HandleSubscriptionChange"
                                           IsLoading="@IsLoading" />
                    </MudStep>

                    <MudStep Title="Billing Details">
                        <BillingDetailsStep @ref="billingStep"
                                            SelectedPlan="@CreatorApplication.CreatorPlan"
                                            SelectedDuration="@CreatorApplication.Duration"
                                            SelectedCurrency="@CreatorApplication.Currency"
                                            BillingData="@CreatorApplication.BillingAddress"
                                            OnBillingDataChanged="@OnBillingDataChanged" />
                    </MudStep>

                    <MudStep Title="Payment">
                        <ChildContent>
                            <PaymentStep @ref="paymentStep"
                                         PaymentData="@CreatorApplication.PaymentInfo"
                                         SelectedPlan="@CreatorApplication.CreatorPlan"
                                         SelectedCurrency="@CreatorApplication.Currency"
                                         OnPaymentDataChanged="@OnPaymentDataChanged" />
                        </ChildContent>
                    </MudStep>
                </MudStepper>
            }
            else
            {
                <!-- Free Trial Mode -->
                <MudStack Spacing="4" AlignItems="AlignItems.Center" Class="py-6">
                    <MudIcon Icon="@Icons.Material.Filled.Celebration" Size="Size.Large" Color="Color.Success" Style="font-size: 4rem;" />
                    <MudText Typo="Typo.h4" Align="Align.Center">Werde jetzt kostenlos Creator!</MudText>
                    <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
                        Teste alle Creator-Features 14 Tage lang kostenlos.
                        Keine Kreditkarte erforderlich!
                    </MudText>

                    <MudPaper Elevation="2" Class="pa-4 rounded-lg" Style="max-width: 500px;">
                        <MudText Typo="Typo.h6" Class="mb-3">Was du bekommst:</MudText>
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                <MudText>Eigener Shop mit Produkten</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                <MudText>Raffles & Gewinnspiele erstellen</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                <MudText>Eigene Landing Page</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                <MudText>Creator Dashboard</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                <MudText>14 Tage kostenloses Testen</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>

                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mt-2">
                        Nach der Testphase kannst du jederzeit auf einen bezahlten Plan upgraden.
                    </MudAlert>
                </MudStack>
            }

            <!-- Plan Selection Toggle -->
            @if (!IsLoading)
            {
                <MudDivider Class="my-4" />
                <MudStack Row="true" Justify="Justify.Center" Spacing="2">
                    <MudButton Variant="@(_isFreeTrial ? Variant.Filled : Variant.Outlined)" 
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.CardGiftcard"
                               OnClick="@(() => SetTrialMode(true))">
                        Kostenlos testen
                    </MudButton>
                    <MudButton Variant="@(!_isFreeTrial ? Variant.Filled : Variant.Outlined)" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.CreditCard"
                               OnClick="@(() => SetTrialMode(false))">
                        Premium Plan wählen
                    </MudButton>
                </MudStack>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" StartIcon="@Icons.Material.Filled.Cancel">
            Abbrechen
        </MudButton>

        <MudSpacer />

        @if (_isFreeTrial)
        {
            <MudButton OnClick="StartFreeTrial" 
                       Variant="Variant.Filled"
                       Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.RocketLaunch" 
                       Disabled="@IsProcessing">
                @if (IsProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Jetzt kostenlos starten!
            </MudButton>
        }
        else if (CurrentStep == 2)
        {
            <MudButton OnClick="SendCreatorApplication" 
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Check" 
                       Disabled="@IsProcessing">
                Creator werden
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public TribeUser TribeProfile { get; set; } = new();

    private MudStepper? stepper;
    private BillingDetailsStep billingStep = default!;
    private PaymentStep paymentStep = default!;

    public CreatorSubscription CreatorApplication { get; set; } = new();
    private List<CreatorPlan>? CreatorPlans { get; set; } = new List<CreatorPlan>();

    private bool IsLoading { get; set; } = true;
    private bool IsProcessing { get; set; } = false;
    private int CurrentStep { get; set; } = 0;
    private bool _isFreeTrial { get; set; } = true; // Default: Free Trial

    protected override async Task OnInitializedAsync()
    {
        CreatorApplication.TribeProfile = TribeProfile;
        CreatorApplication.TribeProfileId = TribeProfile.Id;
        await LoadCreatorPlans();
    }

    private void SetTrialMode(bool isTrial)
    {
        _isFreeTrial = isTrial;
        CurrentStep = 0;
        StateHasChanged();
    }

    /// <summary>
    /// Startet den kostenlosen Test-Creator Modus
    /// </summary>
    private async Task StartFreeTrial()
    {
        if (IsProcessing) return;

        try
        {
            IsProcessing = true;

            // Erstelle eine Free-Trial Subscription mit dem Free-Plan aus der DB
            var trialSubscription = new CreatorSubscription
            {
                TribeProfileId = TribeProfile.Id,
                CreatorPlanId = "free-plan-guid-003", // Free Plan aus der DB
                Duration = "Trial",
                Currency = "EUR",
                SubValue = 0,
                StartDate = DateTime.UtcNow,
                EndDate = DateTime.UtcNow.AddDays(14), // 14 Tage Trial
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow,
                PaymentStatus = "Trial",
                IsActive = true,
                IsPaid = true, // Free = bereits "bezahlt"
                AutoRenew = false
            };

            var options = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
            var json = JsonSerializer.Serialize(trialSubscription, options);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var response = await _client.PostAsync("api/CreatorSubscription/checkout", content);

            if (response.IsSuccessStatusCode)
            {
                var responseJson = await response.Content.ReadAsStringAsync();
                var created = JsonSerializer.Deserialize<CreatorSubscription>(responseJson, options);

                Snackbar.Add("🎉 Willkommen als Creator! Du hast 14 Tage kostenlosen Zugang.", Severity.Success);
                MudDialog.Close(DialogResult.Ok(created));
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _logger?.LogError("Free trial activation failed: {StatusCode} - {ErrorContent}", response.StatusCode, errorContent);
                Snackbar.Add($"Fehler: {errorContent}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error starting free trial: {Message}", ex.Message);
            Snackbar.Add("Ein Fehler ist aufgetreten. Bitte versuche es erneut.", Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task SendCreatorApplication()
    {
        if (IsProcessing) return;
        if (!CanConfirm())
        {
            _logger?.LogWarning("Attempt to submit invalid subscription");
            return;
        }

        try
        {
            IsProcessing = true;

            CreatorApplication.StartDate = DateTime.UtcNow;
            CreatorApplication.CreatedAt = DateTime.UtcNow;
            CreatorApplication.UpdatedAt = DateTime.UtcNow;
            CreatorApplication.PaymentStatus = "Pending";
            CreatorApplication.IsActive = true;
            CreatorApplication.IsPaid = false;

            CreatorApplication.NextPaymentDate = CreatorApplication.Duration switch
            {
                "Monthly" => DateTime.UtcNow.AddMonths(1),
                "Annual" => DateTime.UtcNow.AddYears(1),
                "Lifetime" => null,
                _ => DateTime.UtcNow.AddMonths(1)
            };

            var options = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
            var json = JsonSerializer.Serialize(CreatorApplication, options);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var response = await _client.PostAsync("api/CreatorSubscription/checkout", content);

            if (response.IsSuccessStatusCode)
            {
                var responseJson = await response.Content.ReadAsStringAsync();
                var created = JsonSerializer.Deserialize<CreatorSubscription>(responseJson, options);

                Snackbar.Add("🎉 Herzlich willkommen als Creator!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(created));
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _logger?.LogError("Subscription creation failed: {StatusCode} - {ErrorContent}", response.StatusCode, errorContent);
                Snackbar.Add("Fehler bei der Erstellung. Bitte versuche es erneut.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error sending creator application: {Message}", ex.Message);
            Snackbar.Add("Ein Fehler ist aufgetreten.", Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task LoadCreatorPlans()
    {
        try
        {
            IsLoading = true;
            var response = await _client.GetAsync("api/Creator");

            if (response.IsSuccessStatusCode)
            {
                var responseJson = await response.Content.ReadAsStringAsync();
                var options = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
                CreatorPlans = JsonSerializer.Deserialize<List<CreatorPlan>>(responseJson, options);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _logger?.LogError("LoadCreatorPlans API Error: {StatusCode} - {ErrorContent}", response.StatusCode, errorContent);
                CreatorPlans = new();
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error loading creator plans: {Message}", ex.Message);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSubscriptionChange(CreatorSubscription subscription)
    {
        CreatorApplication = subscription;
        CreatorApplication.TribeProfile = TribeProfile;
        CreatorApplication.TribeProfileId = TribeProfile.Id;
        UpdateSubscriptionValue();
        StateHasChanged();
    }

    private void UpdateSubscriptionValue()
    {
        if (CreatorApplication.CreatorPlanPricing != null)
        {
            CreatorApplication.SubValue = CreatorApplication.Currency switch
            {
                "USD" => (double)CreatorApplication.CreatorPlanPricing.ValueUSD,
                "EUR" => (double)CreatorApplication.CreatorPlanPricing.ValueEuro,
                "GBP" => (double)CreatorApplication.CreatorPlanPricing.ValueGbPound,
                _ => (double)CreatorApplication.CreatorPlanPricing.ValueUSD
            };
        }
    }

    private async Task OnBillingDataChanged(BillingAddress billingData)
    {
        CreatorApplication.BillingAddress = billingData;
        StateHasChanged();
    }

    private async Task OnPaymentDataChanged(PaymentInfo paymentData)
    {
        CreatorApplication.PaymentInfo = paymentData;
        StateHasChanged();
    }

    private bool CanConfirm()
    {
        return CreatorApplication.CreatorPlan != null &&
               !string.IsNullOrEmpty(CreatorApplication.CreatorPlanId) &&
               CreatorApplication.CreatorPlanPricing != null &&
               (billingStep?.IsValid() ?? false) &&
               (paymentStep?.IsValid() ?? false) &&
               !IsProcessing;
    }

    private void Cancel() => MudDialog.Cancel();
}